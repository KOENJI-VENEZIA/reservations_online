<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Table Reservation</title>
  <style>
    /* (styles omitted for brevity) */
  </style>
</head>
<body>
<div class="container">
    <h1>Table Reservation</h1>
    
    <div id="successAlert" class="alert alert-success">...</div>
    <div id="errorAlert" class="alert alert-error">...</div>
    
    <form id="reservationForm">
        <!-- Name, Email, Phone, People, Date, Category, Time, Notes, etc. -->
        <!-- (same as before) -->
        
        <div class="form-group" style="margin-top: 25px;">
            <button type="submit">Request Reservation</button>
        </div>
    </form>
</div>

<!-- Firebase App (the core Firebase SDK) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
<!-- Firestore -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1) Initialize Firebase
    const firebaseConfig = {
      // ... your config ...
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // 2) Basic setup for date/time pickers, etc.
    const today = new Date();
    const dateInput = document.getElementById('date');
    dateInput.min = today.toISOString().split('T')[0];
    dateInput.value = today.toISOString().split('T')[0];
    
    function updateTimeSlots() {
        // ... as in your original code ...
    }
    updateTimeSlots();
    document.getElementById('category').addEventListener('change', updateTimeSlots);
    
    document.getElementById('date').addEventListener('change', function(e) {
        const selectedDate = new Date(e.target.value);
        if (selectedDate.getDay() === 1) { // Monday
            alert('We are closed on Mondays. Please select another day.');
            e.target.value = '';
        }
    });
    
    // 3) Handle Form Submission
    document.getElementById('reservationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        successAlert.style.display = 'none';
        errorAlert.style.display = 'none';
        
        // 3a) Gather form values
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const numberOfPersons = parseInt(document.getElementById('numberOfPersons').value);
        const dateString = document.getElementById('date').value;
        const category = document.getElementById('category').value;
        const startTime = document.getElementById('startTime').value;
        const userNotes = document.getElementById('notes').value;
        
        // 3b) Append "[web reservation]; Email: ..." if you like
        const notes = `${userNotes}; [web reservation]; Email: ${email}`;
        
        // 3c) Compute endTime (1h45m after startTime)
        const [startHour, startMinute] = startTime.split(':').map(Number);
        let endHour = startHour;
        let endMinute = startMinute + 45;
        if (endMinute >= 60) {
            endHour += 1;
            endMinute -= 60;
        }
        if (category === 'lunch') {
            endHour += 1; // extra hour for lunch
        } else {
            endHour += 1; // extra hour for dinner
        }
        const endTime = String(endHour).padStart(2, '0') + ":" + String(endMinute).padStart(2, '0');
        
        // 3d) Generate a UUID for the reservation
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        const reservationId = uuidv4();
        
        // 3e) Instead of Firestore Timestamp, store numeric Unix time as Double
        const nowSeconds = Date.now() / 1000; // e.g. 1677604800.123
        
        // 3f) Create reservation doc that matches the fields
        const reservation = {
            id: reservationId,            // required (String → UUID)
            name: name,                   // (String)
            phone: phone,                 // (String)
            email: email,                 // optional but for “web”
            numberOfPersons: numberOfPersons, // (Int)
            dateString: dateString,       // (String, e.g. "2025-03-03")
            category: category,           // (String that matches an enum rawValue)
            startTime: startTime,         // (String, e.g. "12:00")
            endTime: endTime,             // (String, e.g. "13:45")
            
            acceptance: "toConfirm",      // e.g. your Swift code’s .toConfirm
            status: "pending",            // must match Swift’s ReservationStatus enum
            reservationType: "inAdvance", // must match Swift’s ReservationType enum
            group: false,                 // (Bool)
            notes: notes,                 // (String)
            tables: [],                   // (Array) - can be empty
            creationDate: nowSeconds,     // your code expects a Double
            lastEditedOn: nowSeconds,     // ditto
            isMock: false,                // (Bool)
            assignedEmoji: "",            // optional
            source: "web"                 // (String)
        };
        
        // 4) Write doc to Firestore
        const collectionName = "reservations"; // or "reservations_release" in production
        db.collection(collectionName).doc(reservationId)
            .set(reservation)
            .then(() => {
                console.log("Reservation saved with ID:", reservationId);
                successAlert.style.display = 'block';
                document.getElementById('reservationForm').reset();
                updateTimeSlots(); // Clear & reset time slots
            })
            .catch((error) => {
                console.error("Error adding reservation:", error);
                errorAlert.style.display = 'block';
            });
    });
});
</script>
</body>
</html>
